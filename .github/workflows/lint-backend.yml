name: Lint Backend

on:
  push:
    paths:
      - "backend/**"
      - ".github/workflows/**"
  pull_request:
    paths:
      - "backend/**"
      - ".github/workflows/**"

concurrency:
  group: lint-backend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-dev.txt
            backend/pyproject.toml

      - name: Install deps (project + linters)
        run: |
          python -m pip install --upgrade pip
          [[ -f requirements.txt ]] && pip install -r requirements.txt
          [[ -f requirements-dev.txt ]] && pip install -r requirements-dev.txt
          [[ -f pyproject.toml ]] && pip install .
          pip install "black==24.8.0" "isort==5.13.2" "ruff==0.6.9" "pylint==3.2.6" "flake8==7.1.1"

      - name: isort (imports check)
        run: isort --check-only --df .

      - name: Black (format check)
        run: black --check --diff .

      - name: Ruff (optional)
        run: ruff check . || true

      - name: Pylint
        run: |
          TARGETS="."
          [[ -d app ]] && TARGETS="app"
          [[ -d src ]] && TARGETS="src"
          [[ -d credit_management ]] && TARGETS="credit_management"
          [[ -d analytics ]] && TARGETS="$TARGETS analytics"
          [[ -d notifications ]] && TARGETS="$TARGETS notifications"
          pylint $TARGETS

      - name: Flake8 (optional)
        run: flake8 . || true
