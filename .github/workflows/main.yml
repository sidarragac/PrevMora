name: Lint Backend

on:
  pull_request:
    paths:
      - "backend/**"
      - ".github/workflows/lint-backend.yml"
  push:
    branches: [ main, develop ]
    paths:
      - "backend/**"
      - ".github/workflows/lint-backend.yml"

concurrency:
  group: lint-backend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-dev.txt
            backend/pyproject.toml

      - name: Install dependencies (prod + dev si existe)
        run: |
          python -m pip install --upgrade pip
          if [[ -f requirements.txt ]]; then pip install -r requirements.txt; fi
          if [[ -f requirements-dev.txt ]]; then pip install -r requirements-dev.txt; fi
          # Soporte para pyproject (ruff/black/isort/pylint en tool.poetry/pep621)
          if [[ -f pyproject.toml ]]; then pip install .; fi

      - name: Show tool versions
        run: |
          python -V || true
          black --version || true
          isort --version || true
          pylint --version || true
          ruff --version || true
          flake8 --version || true

      - name: Black (format check)
        run: |
          black --check --diff .

      - name: isort (imports check)
        run: |
          isort --check-only --df .

      - name: Ruff (lints rápidos, opcional)
        if: always()
        run: |
          ruff check .

      - name: Pylint (estricto sobre src/app)
        run: |
          # Ajusta rutas según tu estructura (ej: app/, src/, credit_management/)
          TARGETS="."
          # Ejemplo afinado: pylint solo al paquete de la app
          if [[ -d app ]]; then TARGETS="app"; fi
          if [[ -d src ]]; then TARGETS="src"; fi
          if [[ -d credit_management ]]; then TARGETS="credit_management"; fi
          pylint $TARGETS

      - name: Flake8 (opcional, si usas flake8)
        if: always()
        run: |
          flake8 . || true 
